#include "stm32f767xx.h"

void init_all()
{
	RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN | RCC_AHB1ENR_GPIOBEN;
	RCC->APB1ENR |= RCC_APB1ENR_TIM4EN;
	RCC->APB2ENR |= RCC_APB2ENR_SYSCFGEN | RCC_APB2ENR_ADC1EN | RCC_APB2ENR_USART1EN;

	GPIOB->MODER |= GPIO_MODER_MODER8_1;
	GPIOB->AFR[1] |= GPIO_AFRH_AFRH0_1;
	TIM4->PSC = 16;
	TIM4->ARR = 4096;
	TIM4->CCR3 = 50;
	TIM4->CCMR2 |= TIM_CCMR2_OC3M_1 | TIM_CCMR2_OC3M_2;
	TIM4->CCER |= TIM_CCER_CC3E;
	TIM4->CR1 |= TIM_CR1_CEN;

	GPIOA->MODER |= GPIO_MODER_MODER3;
	ADC1->JSQR |= ADC_JSQR_JSQ4_0 | ADC_JSQR_JSQ4_1;
	ADC1->CR2 |= ADC_CR2_ADON;
}

int main(void)
{
	init_all();
	while(1){
		ADC1->CR2 |= ADC_CR2_JSWSTART;
		while (!(ADC1->SR & ADC_SR_JEOC));
	    ADC1->SR = 0;
	    TIM4->CCR3 = ADC1->JDR1;
	}
}

